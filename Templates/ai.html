<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Phoenix Voice Assistant</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Poppins:wght@400;600&display=swap"
    rel="stylesheet" />
  <style>
    /* Global style */
    body {
      min-height: 100vh;     /* Allow page to grow */
  height: auto;          /* Content decides height */
  margin: 0;
  padding: 0;
  background: radial-gradient(circle at center, #000010, #000015, #000);
  font-family: 'Poppins', sans-serif;
  color: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;   /* Move content UP so it looks natural */
  overflow-y: auto;    
    }

    /* Header */
    header {
      position: absolute;
      top: 40px;
      left: 60px;
      font-family: 'Orbitron', sans-serif;
      font-size: 1.8rem;
      letter-spacing: 3px;
      background: linear-gradient(90deg, #00e0ff, #ff00d4);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 0 20px #00f0ff88;
      z-index: 5;
    }

    /* Profile icon */
    .profile-icon {
      position: absolute;
      top: 32px;
      right: 200px;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, 0.5);
      background: radial-gradient(circle, #00ffe0 0%, #0077ff 90%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      cursor: pointer;
      box-shadow: 0 0 15px rgba(0, 255, 255, 0.6);
      z-index: 5;
      transition: 0.2s ease;
    }

    .profile-icon:hover {
      transform: scale(1.1);
      box-shadow: 0 0 25px rgba(0, 255, 255, 1);
    }

    /* Back button */
    .back-btn {
      position: absolute;
      top: 32px;
      right: 40px;
      padding: 10px 28px;
      border-radius: 40px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      background: linear-gradient(90deg, #00eaff, #0077ff);
      color: white;
      box-shadow: 0 0 20px rgba(0, 150, 255, 0.6);
      transition: 0.25s ease-in-out;
      z-index: 5;
    }

    .back-btn:hover {
      transform: scale(1.08);
      box-shadow: 0 0 30px rgba(0, 180, 255, 1);
    }

    /* Bluetooth button */
    .bluetooth-btn {
      position: absolute;
      top: 32px;
      right: 260px;
      padding: 10px 20px;
      border-radius: 40px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      background: linear-gradient(90deg, #00ffbb, #00b4ff);
      color: black;
      box-shadow: 0 0 16px rgba(0, 255, 200, 0.7);
      z-index: 5;
      transition: 0.25s;
    }

    .bluetooth-btn:hover {
      transform: scale(1.08);
      box-shadow: 0 0 26px rgba(0, 255, 255, 1);
    }

    /* Core AI UI */
    #reply {
       position: absolute;
    top: 90%;                /* move text DOWN */
    left: 50%;
    transform: translateX(-50%);
    -webkit-text-fill-color: white;
    color: white;
    font-size: 1.6rem;
    margin-bottom: 20px;
    font-family: 'Orbitron', sans-serif;
    letter-spacing: 2px;
    text-align: center;
    max-width: 80%;
    word-wrap: break-word;
    z-index: 9999;
    }
    #talkBtn {
    position: absolute;
    top:72%;       /* PUSH BUTTON DOWN */
    transform: translateX(-50%);
    z-index: 9999; 
    left: 50%;
}

    button {
      padding: 12px 30px;
      border-radius: 40px;
      border: none;
      cursor: pointer;
      font-size: 1.1rem;
      font-weight: 600;
      letter-spacing: 1px;
      background: linear-gradient(90deg, #00d9ff, #0072ff);
      color: #fff;
      box-shadow: 0 0 20px rgba(0, 217, 255, 0.4);
      transition: 0.3s ease;
      margin: 5px;
    }

    button:hover {
      transform: scale(1.08);
      box-shadow: 0 0 30px rgba(0, 217, 255, 0.8);
    }

    /* PC IP container */
    .pc-control-container {
      position:absolute;
      bottom: 20%;
      left:20%;
      transform: translateX(-50%);
      background: rgba(8, 16, 40, 0.85);
      padding: 1px 1px; ;
      border-radius: 22px;
      border: 1px solid rgba(0, 255, 255, 0.35);
      box-shadow: 0 0 35px rgba(0, 255, 255, 0.18);
      backdrop-filter: blur(14px);
      z-index: 5;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .pc-control-container input {
      padding: 10px 20px;
      border-radius: 20px;
      border: 1px solid rgba(0, 255, 255, 0.5);
      background: rgba(0, 0, 40, 0.9);
      color: #fff;
      font-size: 0.95rem;
      width: 200px;
      outline: none;
    }

    .pc-control-container input:focus {
      border-color: #00f5ff;
      box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
    }

    .pc-control-container label {
      font-size: 0.95rem;
      color: #bcbcbc;
    }

    /* CMD Mode toggle */
   .mode-row {
    position: absolute;
    top:50%;            /* Adjust row position */
    width: 80%;
    
    display: flex;
    justify-content: space-between; /* LEFT & RIGHT */
    align-items: center;
    z-index: 5;
}

/* Phoenix Mode (LEFT SIDE) */
.phoenix-mode-toggle {
    background: rgba(8, 16, 40, 0.95);
    padding: 18px 35px;
    border-radius: 30px;
    border: 2px solid rgba(255, 0, 180, 0.6);
    box-shadow: 0 0 40px rgba(255, 0, 180, 0.25);
    display: flex;
    align-items: center;
    gap: 20px;
    transition: 0.3s ease;
    bottom:70px;
    left:5%;
}
.phoenix-mode-toggle.active {
    border-color: #ff00aa;
    box-shadow: 0 0 60px rgba(255, 0, 200, 0.5);
    background: rgba(40, 0, 40, 0.95);
}
.phoenix-mode-toggle label {
    font-size: 1.1rem;
    font-weight: 700;
    letter-spacing: 1px;
    color: #ff66c4;
    text-transform: uppercase;
}
.phoenix-mode-toggle.active label {
    color: #ff00dd;
    text-shadow: 0 0 10px #ff00dd;
}

/* CMD Mode (RIGHT SIDE) */
.cmd-mode-toggle {
    background: rgba(8, 16, 40, 0.95);
    padding: 18px 35px;
    border-radius: 30px;
    border: 2px solid rgba(255, 100, 0, 0.6);
    box-shadow: 0 0 40px rgba(255, 100, 0, 0.25);
    display: flex;
    align-items: center;
    gap: 20px;
    transition: 0.3s ease;
}
.cmd-mode-toggle.active {
    border-color: #00ff88;
    box-shadow: 0 0 60px rgba(0, 255, 136, 0.5);
    background: rgba(0, 40, 20, 0.95);
}
.cmd-mode-toggle label {
    font-size: 1.1rem;
    font-weight: 700;
    letter-spacing: 1px;
    color: #ffaa80;
    text-transform: uppercase;
}
.cmd-mode-toggle.active label {
    color: #00ff88;
    text-shadow: 0 0 10px #00ff88;
}

/* Switch Style (same for both toggles) */
.toggle-switch {
    position: relative;
    width: 50px;
    height: 26px;
    background: rgba(100, 100, 100, 0.5);
    border-radius: 20px;
    cursor: pointer;
    transition: 0.3s;
}
.toggle-switch.active {
    background: linear-gradient(90deg, #00ff88, #00cc66);
}
.toggle-slider {
    position: absolute;
    top: 3px;
    left: 3px;
    width: 20px;
    height: 20px;
    background: white;
    border-radius: 50%;
    transition: 0.3s;
}
.toggle-switch.active .toggle-slider {
    transform: translateX(24px);
}


    #status {
      margin-top: 10px;
      font-size: 0.98rem;
      color: #9beeff;
      text-shadow: 0 0 12px rgba(0, 255, 255, 0.6);
      font-style: italic;
      min-height: 1.4em;
      text-align: center;
    }

    @keyframes glow {
      from {
        text-shadow: 0 0 20px #00faff44, 0 0 30px #ff00ff22;
      }

      to {
        text-shadow: 0 0 40px #00faffaa, 0 0 60px #ff00ff55;
      }
    }

    @keyframes pulse-glow {
      0% {
        box-shadow: 0 0 0 0 rgba(0, 234, 255, 0.4);
      }

      70% {
        box-shadow: 0 0 0 20px rgba(0, 234, 255, 0);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(0, 234, 255, 0);
      }
    }

    .phoenix-main-btn {
      padding: 20px 50px;
      font-size: 1.5rem;
      border-radius: 60px;
      background: linear-gradient(90deg, #00eaff, #0077ff);
      box-shadow: 0 0 30px rgba(0, 234, 255, 0.6);
      animation: pulse-glow 2s infinite;
      margin: 30px 0;
      border: 2px solid rgba(255, 255, 255, 0.2);
      text-transform: uppercase;
      letter-spacing: 2px;
      font-family: 'Orbitron', sans-serif;
    }

    .phoenix-main-btn:hover {
      transform: scale(1.05);
      background: linear-gradient(90deg, #0077ff, #00eaff);
      box-shadow: 0 0 50px rgba(0, 234, 255, 0.9);
    }

    .phoenix-main-btn .icon {
      margin-right: 10px;
      font-size: 1.8rem;
    }

    /* Enhanced CMD Mode Toggle */
    
    /* ==============================
   SUPER REALISTIC PHOENIX ROBOT
================================*/

.phoenix-section {
    position: absolute;
    top: 10%;
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.phoenix-robot {
  position: relative;
  width: 300px;     /* was 380px */
  height: 360px;
  transform: translateY(30px);
}

.robot-aura {
  position: absolute;
  top: -6%;
  left: 50%;
  transform: translateX(-50%);
  width: 130%;
  height: 130%;
  background: radial-gradient(circle, #00eaff33, #00112200 70%);
  border-radius: 50%;
  filter: blur(40px);
  animation: pulseAura 4s infinite ease-in-out;
}

@keyframes pulseAura {
  0%,100% { opacity: 0.5; }
  50% { opacity: 1; }
}

.robot-head {
  position: absolute;
  top: 5%;
  left: 50%;
  width: 78%;
  height: 55%;
  transform: translateX(-50%);
  background: radial-gradient(circle at 50% 20%, #0a1740, #000012);
  border-radius: 50% 50% 45% 45%;
  box-shadow: 0 0 40px #00c8ff44 inset, 0 0 45px #009dff33;
}

.robot-face {
  position: absolute;
  top: 33%;
  left: 50%;
  width: 60%;
  height: 32%;
  transform: translateX(-50%);
  background: linear-gradient(180deg, #06142e, #000814);
  border-radius: 30px;
  box-shadow: 0 0 25px #00d0ff55 inset, 0 0 40px #00c8ff55;
}

.robot-cheek {
  position: absolute;
  top: 44%;
  width: 22%;
  height: 10%;
  background: linear-gradient(90deg, #00eaff44, #00fff322);
  border-radius: 20px;
  filter: blur(5px);
}
.robot-cheek.left { left: 12%; }
.robot-cheek.right { right: 12%; }

.robot-eyes-up {
  position: absolute;
  top: 40%;
  left: 50%;
  width: 52%;
  height: 22%;
  transform: translateX(-50%);
  display: flex;
  justify-content: space-between;
}

.robot-eye {
  width: 40%;
  position: relative;
}

.eye-ring {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  background: radial-gradient(circle, #00eaff66, transparent 60%);
  filter: blur(8px);
  position: absolute;
  top: 0;
}

.eye-core {
  width: 62%;
  height: 62%;
  background: radial-gradient(circle at 30% 30%, #ffffff, #9ee8ff, #00c8ff);
  border-radius: 50%;
  margin: auto;
  margin-top: 18%;
  z-index: 2;
  filter: drop-shadow(0 0 14px #00eaff);
  transition: 0.15s linear;
}

.eye-lid {
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 100%;
  background: #020b3a;
  border-radius: 50%;
  transform-origin: top;
  transform: scaleY(0);
  z-index: 5;
}

@keyframes blink {
  0% { transform: scaleY(0); }
  40% { transform: scaleY(1); }
  60% { transform: scaleY(1); }
  100% { transform: scaleY(0); }
}

.robot-core {
  position: absolute;
  bottom: 9%;
  left: 50%;
  transform: translateX(-50%);
  width: 38px;
  height: 14px;
  background: #00eaff;
  border-radius: 5px;
  box-shadow: 0 0 20px #00eaff, 0 0 30px #009dff;
  animation: corePulse 2s infinite ease-in-out;
}

@keyframes corePulse {
  0%,100% { transform: translateX(-50%) scale(1); opacity: .7; }
  50% { transform: translateX(-50%) scale(1.22); opacity: 1; }
}

  </style>
</head>

<body>
  <header>‚ö° PHOENIX</header>
  <div class="profile-icon" onclick="window.location.href='{{ url_for('settings_page') }}'">üë§</div>
  <button class="bluetooth-btn" onclick="requestBluetooth()">üîµ Connect Bluetooth</button>
  <button class="back-btn" onclick="window.location.href='{{ url_for('dashboard') }}'">‚¨Ö Back</button>
  <div id="reply"></div>
  <button id="talkBtn">üé§ Talk to Phoenix</button>
  <div id="status">Waiting for command...</div>
  <!-- Phoenix Mode Toggle -->
  <div class="mode-row">

    <!-- Phoenix Mode Toggle (LEFT) -->
    <div class="phoenix-mode-toggle" id="phoenixModeToggle">
        <label for="phoenixModeSwitch">üî• PHOENIX MODE</label>
        <div class="toggle-switch" id="phoenixModeSwitch" onclick="togglePhoenixMode()">
            <div class="toggle-slider"></div>
        </div>
    </div>

    <!-- CMD Mode Toggle (RIGHT) -->
    <div class="cmd-mode-toggle" id="cmdModeToggle">
        <label for="cmdModeSwitch">üíª CMD Mode</label>
        <div class="toggle-switch" id="cmdModeSwitch" onclick="toggleCmdMode()">
            <div class="toggle-slider"></div>
        </div>
    </div>

</div>
  <!-- PC Control Input -->
  <div class="pc-control-container">
    <label for="pcIpInput">PC IP:</label>
    <input type="text" id="pcIpInput" placeholder="192.168.1.100" />
    <button onclick="savePcIp()">Save IP</button>
  </div>
  <!--face-->
  <div class="phoenix-section">
  <div class="phoenix-robot">
    <div class="robot-aura"></div>
    <div class="robot-head"></div>

    <div class="robot-face"></div>

    <div class="robot-cheek left"></div>
    <div class="robot-cheek right"></div>

    <div class="robot-eyes-up">
      <div class="robot-eye">
        <div class="eye-ring"></div>
        <div class="eye-core"></div>
        <div class="eye-lid"></div>
      </div>
      <div class="robot-eye">
        <div class="eye-ring"></div>
        <div class="eye-core"></div>
        <div class="eye-lid"></div>
      </div>
    </div>

    <div class="robot-core"></div>
  </div>
</div>

<canvas id="voiceWave" width="800" height="200"
style="width:100%; max-width:900px; height:200px; margin-top:300px;"></canvas>

  <script>
    // CMD Mode state
    let cmdModeActive = false;
    let phoenixModeActive = false;
    function toggleCmdMode() {
      cmdModeActive = !cmdModeActive;
      const toggle = document.getElementById('cmdModeToggle');
      const switchEl = document.getElementById('cmdModeSwitch');
      if (cmdModeActive) {
        toggle.classList.add('active');
        switchEl.classList.add('active');
        speak('Command mode activated. All voice input will be sent directly to PC command prompt.');
        document.getElementById('status').textContent = 'üíª CMD Mode: ON - Direct command execution';
      } else {
        toggle.classList.remove('active');
        switchEl.classList.remove('active');
        speak('Command mode deactivated. Returning to normal AI mode.');
        document.getElementById('status').textContent = 'ü§ñ AI Mode: ON - Normal operation';
      }
    }
    function togglePhoenixMode() {
  phoenixModeActive = !phoenixModeActive;

  const toggle = document.getElementById("phoenixModeToggle");
  const switchEl = document.getElementById("phoenixModeSwitch");

  if (phoenixModeActive) {
    toggle.classList.add("active");
    switchEl.classList.add("active");
    speak("Phoenix mode activated. Robot-only commands enabled.");
    document.getElementById("status").textContent = "üî• Phoenix Mode: ON";
  } else {
    toggle.classList.remove("active");
    switchEl.classList.remove("active");
    speak("Phoenix mode deactivated. Returning to AI mode.");
    document.getElementById("status").textContent = "ü§ñ AI Mode: ON";
  }
}
    // Bluetooth globals
    let bleDevice = null, bleServer = null, bleService = null, bleCharacteristic = null;
    const SERVICE_UUID = "0000ffe0-0000-1000-8000-00805f9b34fb";
    const CHARACTERISTIC_UUID = "0000ffe1-0000-1000-8000-00805f9b34fb";
    const COMMAND_MAP = { "Forward": "F", "Backward": "B", "Left": "L", "Right": "R", "Stop": "S" };
    async function requestBluetooth() {
      if (!navigator.bluetooth) { alert('Bluetooth not supported in this browser.'); return; }
      try {
        document.getElementById('status').textContent = 'Requesting Bluetooth device...';
        const device = await navigator.bluetooth.requestDevice({ acceptAllDevices: true, optionalServices: [SERVICE_UUID] });
        bleDevice = device;
        document.getElementById('status').textContent = 'Connecting to ' + (device.name || 'robot') + '...';
        bleDevice.addEventListener('gattserverdisconnected', onDisconnected);
        bleServer = await bleDevice.gatt.connect();
        bleService = await bleServer.getPrimaryService(SERVICE_UUID);
        bleCharacteristic = await bleService.getCharacteristic(CHARACTERISTIC_UUID);
        document.getElementById('status').textContent = '‚úÖ Bluetooth connected: ' + (device.name || 'robot');
      } catch (e) { console.error(e); document.getElementById('status').textContent = '‚ö†Ô∏è Bluetooth connection failed.'; }
    }
    function onDisconnected() { bleServer = bleService = bleCharacteristic = null; document.getElementById('status').textContent = '‚ùå Bluetooth disconnected.'; }
    async function sendRobotCommand(cmd) {
      if (!bleCharacteristic) { document.getElementById('status').textContent = '‚ö†Ô∏è Connect Bluetooth first.'; return; }
      const short = COMMAND_MAP[cmd] || cmd.charAt(0);
      try {
        const enc = new TextEncoder();
        await bleCharacteristic.writeValue(enc.encode(short));
        document.getElementById('status').textContent = `Command: ${cmd} ‚ö°`;
      } catch (e) { console.error(e); document.getElementById('status').textContent = '‚ö†Ô∏è Failed to send command.'; }
    }
    // PC IP storage
    function savePcIp() {
      const ip = document.getElementById('pcIpInput').value.trim();
      if (ip) { localStorage.setItem('phoenixPcIp', ip); speak(`PC IP address saved as ${ip}`); document.getElementById('status').textContent = `‚úÖ PC IP saved: ${ip}`; }
      else { speak('Please enter a valid IP address'); }
    }
    function getPcIp() { return localStorage.getItem('phoenixPcIp') || ''; }
    window.addEventListener('DOMContentLoaded', () => { const ip = getPcIp(); if (ip) document.getElementById('pcIpInput').value = ip; });
    // Map voice to PC commands
    function mapPcCommand(txt) {
      const map = { "open chrome": "start chrome", "open firefox": "start firefox", "open notepad": "start notepad", "open calculator": "start calc", "open paint": "start mspaint", "open cmd": "start cmd", "open powershell": "start powershell", "shutdown": "shutdown /s /t 0", "restart": "shutdown /r /t 0", "lock": "rundll32.exe user32.dll,LockWorkStation" };
      for (const [k, v] of Object.entries(map)) if (txt.includes(k)) return v;
      if (txt.startsWith('open ')) return 'start ' + txt.replace('open ', '').trim();
      return txt;
    }
    async function sendPcCommand(command) {
      const ip = getPcIp();
      if (!ip) { speak('Please set the PC IP address first'); document.getElementById('status').textContent = '‚ö†Ô∏è Please set PC IP address first'; return; }
      try {
        const res = await fetch('/send_pc_command', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ip, command }) });
        const data = await res.json();
        if (data.success) { speak(`Command sent to PC: ${command}`); document.getElementById('status').textContent = `‚úÖ Command sent: ${command}`; }
        else { speak(`Failed to send command: ${data.error}`); document.getElementById('status').textContent = `‚ö†Ô∏è Error: ${data.error}`; }
      } catch (e) { console.error(e); speak('Failed to send command to PC'); document.getElementById('status').textContent = '‚ö†Ô∏è Failed to send command'; }
    }
    // Voice assistant
    let phoenixMemory = JSON.parse(localStorage.getItem('phoenixMemory')) || {};
    function saveMemory() { localStorage.setItem('phoenixMemory', JSON.stringify(phoenixMemory)); }
    const phoenixUser = '{{ username }}';
    window.speechSynthesis.onvoiceschanged = () => { console.log(speechSynthesis.getVoices()); };
    let recognition; let listening = false;
    if ('webkitSpeechRecognition' in window) recognition = new webkitSpeechRecognition();
    else if ('SpeechRecognition' in window) recognition = new SpeechRecognition();
    else document.getElementById('reply').innerText = '‚ö†Ô∏è Speech recognition not supported.';
    if (recognition) {
      recognition.continuous = true; recognition.interimResults = false; recognition.lang = 'en-US';
      recognition.onresult = async (e) => {
        window.speechSynthesis.cancel();
        const text = e.results[e.results.length - 1][0].transcript.trim().toLowerCase();
        console.log('Heard:', text);
        // CMD mode activation phrases
        if (text.includes('enter command mode') || text.includes('activate command mode') || text.includes('enable command mode')) { if (!cmdModeActive) toggleCmdMode(); return; }
        if (text.includes('exit command mode') || text.includes('deactivate command mode') || text.includes('disable command mode')) { if (cmdModeActive) toggleCmdMode(); return; }
        // If CMD mode active, send directly to PC
        if (cmdModeActive) { await sendPcCommand(text); document.getElementById('reply').innerText = `üíª CMD: ${text}`; return; }
        // Robot controls
        // if (text.includes('move forward') || text.includes('go forward') || text.includes('forward')) { await sendRobotCommand('Forward'); speak('Moving forward'); document.getElementById('reply').innerText = 'ü§ñ Phoenix: Moving robot forward'; return; }
        // if (text.includes('move backward') || text.includes('go backward') || text.includes('backward') || text.includes('go back')) { await sendRobotCommand('Backward'); speak('Moving backward'); document.getElementById('reply').innerText = 'ü§ñ Phoenix: Moving robot backward'; return; }
        // if (text.includes('turn left') || text.includes('go left') || text.includes('left')) { await sendRobotCommand('Left'); speak('Turning left'); document.getElementById('reply').innerText = 'ü§ñ Phoenix: Turning robot left'; return; }
        // if (text.includes('turn right') || text.includes('go right') || text.includes('right')) { await sendRobotCommand('Right'); speak('Turning right'); document.getElementById('reply').innerText = 'ü§ñ Phoenix: Turning robot right'; return; }
        // if (text.includes('stop robot') || text.includes('robot stop') || (text.includes('stop') && text.includes('robot'))) { await sendRobotCommand('Stop'); speak('Robot stopped'); document.getElementById('reply').innerText = 'ü§ñ Phoenix: Robot stopped'; return; }
        // ------------------------------------------
        // üî• PHOENIX MODE (Robot-Only Mode)
        // ------------------------------------------
        if (phoenixModeActive) {

          // Movement: forward
          if (text.includes('forward')) {
            await sendRobotCommand('Forward');
            document.getElementById('reply').innerText = 'üî• Phoenix Mode: Robot Forward';
            speak('Moving forward');
            return;
          }

          // Movement: backward
          if (text.includes('back') || text.includes('backward')) {
            await sendRobotCommand('Backward');
            document.getElementById('reply').innerText = 'üî• Phoenix Mode: Robot Backward';
            speak('Moving backward');
            return;
          }

          // Movement: left
          if (text.includes('left')) {
            await sendRobotCommand('Left');
            document.getElementById('reply').innerText = 'üî• Phoenix Mode: Robot Left';
            speak('Turning left');
            return;
          }

          // Movement: right
          if (text.includes('right')) {
            await sendRobotCommand('Right');
            document.getElementById('reply').innerText = 'üî• Phoenix Mode: Robot Right';
            speak('Turning right');
            return;
          }

          // Stop
          if (text.includes('stop')) {
            await sendRobotCommand('Stop');
            document.getElementById('reply').innerText = 'üî• Phoenix Mode: Robot Stop';
            speak('Stopping robot');
            return;
          }

          // Unknown command inside phoenix mode
          document.getElementById('reply').innerText = '‚ö† Phoenix Mode: Only robot movement commands allowed';
          speak('Only robot commands are allowed in phoenix mode');
          return;
        }

        // PC commands
        if (text.includes('open ') || text.includes('start ') || text.includes('launch ')) {
          const pcCmd = mapPcCommand(text);
          await sendPcCommand(pcCmd);
          document.getElementById('reply').innerText = `ü§ñ Phoenix: Sending command to PC: ${pcCmd}`;
          return;
        }
        if (text.includes('shutdown') || text.includes('shut down')) { await sendPcCommand('shutdown /s /t 0'); speak('Sending shutdown command'); document.getElementById('reply').innerText = 'ü§ñ Phoenix: Sending shutdown command'; return; }
        if (text.includes('restart') || text.includes('reboot')) { await sendPcCommand('shutdown /r /t 0'); speak('Sending restart command'); document.getElementById('reply').innerText = 'ü§ñ Phoenix: Sending restart command'; return; }
        if (text.includes('lock') && text.includes('pc')) { await sendPcCommand('rundll32.exe user32.dll,LockWorkStation'); speak('Locking PC'); document.getElementById('reply').innerText = 'ü§ñ Phoenix: Locking PC'; return; }
        // Memory commands
        if (text.includes('tell my name') || text.includes('what is my name') || text.includes("what's my name")) {
          const msg = phoenixUser ? `Your name is ${phoenixUser}.` : 'I don\'t have your name yet.'; speak(msg); document.getElementById('reply').innerText = 'ü§ñ Phoenix: ' + msg; return;
        }
        if (text.startsWith('my ') && text.includes(' is ')) {
          const before = text.split(' is ')[0]; const val = text.split(' is ')[1]; const key = before.replace('my ', '').replace(/ /g, '_'); phoenixMemory[key] = val; saveMemory(); const msg = `Got it. I will remember your ${key.replace('_', ' ')} is ${val}.`; speak(msg); document.getElementById('reply').innerText = 'ü§ñ Phoenix: ' + msg; return;
        }
        if (text.startsWith('what is my ')) {
          const key = text.replace('what is my ', '').replace(/ /g, '_'); if (phoenixMemory[key]) { const msg = `Your ${key.replace('_', ' ')} is ${phoenixMemory[key]}.`; speak(msg); document.getElementById('reply').innerText = 'ü§ñ Phoenix: ' + msg; } else { const msg = 'I don\'t have that information yet.'; speak(msg); document.getElementById('reply').innerText = 'ü§ñ Phoenix: ' + msg; } return;
        }
        // Control commands
        if (text.includes('stop phoenix')) { window.speechSynthesis.cancel(); document.getElementById('reply').innerText = 'üõë Phoenix stopped speaking but still listening.'; return; }
        if (text.includes('exit phoenix')) {
          window.speechSynthesis.cancel();
          const exitMsg = 'Shutting down. Phoenix going offline.';
          document.getElementById('reply').innerText = 'ü§ñ Phoenix: ' + exitMsg;
          speak(exitMsg);
          setTimeout(() => {
            recognition.stop();
            listening = false;
            const btn = document.getElementById('talkBtn');
            btn.innerHTML = '<span class="icon">üéôÔ∏è</span> ENABLE PHOENIX AI';
            btn.style.background = ''; // Reset to CSS default
            btn.style.boxShadow = '';
          }, 1500);
          return;
        }
        // Default AI response
        document.getElementById('reply').innerText = 'üó£Ô∏è You: ' + text;
        setTimeout(async () => { try { const res = await fetch(`/ask_text?text=${encodeURIComponent(text)}`); const data = await res.json(); document.getElementById('reply').innerText = 'ü§ñ Phoenix: ' + data.reply; speak(data.reply); } catch (err) { console.error('Backend error:', err); document.getElementById('reply').innerText = '‚ö†Ô∏è Error: ' + err.message; } }, 100);
      };
      recognition.onerror = e => { if (e.error === 'not-allowed') document.getElementById('reply').innerText = '‚ö†Ô∏è Microphone access denied!'; };
      recognition.onend = () => { if (listening) recognition.start(); };
    }
    document.getElementById("talkBtn").addEventListener("click", () => {
  if (!recognition) return;

  if (!listening) {
    listening = true;
    recognition.start();

    // Custom greeting message
    const niceGreeting = phoenixUser
      ? `Hey ${phoenixUser}, I'm awake and fully online. What can I do for you?`
      : "Phoenix online and ready. Listening...";

    speak(niceGreeting);

    document.getElementById("reply").innerText = "ü§ñ " + niceGreeting;

    const btn = document.getElementById('talkBtn');
    btn.innerHTML = '<span class="icon">üõë</span> LISTENING...';
    btn.style.background = 'linear-gradient(90deg, #ff005e, #ff4da6)';
    btn.style.boxShadow = '0 0 40px rgba(255, 0, 94, 0.6)';
  }
});
    
   function speak(text) {
    const synth = window.speechSynthesis;
    let voices = synth.getVoices();

    if (!voices || voices.length === 0) {
        synth.onvoiceschanged = () => speak(text);
        return;
    }

    phoenixSpeaking = true;

    const utter = new SpeechSynthesisUtterance(text);
    utter.rate = 1.0;
    utter.pitch = 0.9;
    utter.volume = 1;

    utter.voice =
        voices.find(v => v.name.includes("Google UK English Male")) ||
        voices.find(v => v.name.includes("Google US English")) ||
        voices.find(v => v.lang === "en-US") ||
        voices[0];

    utter.onend = () => {
        phoenixSpeaking = false;
    };

    synth.cancel();
    synth.speak(utter);
}

  /* --- Wave Animation --- */
let phoenixSpeaking = false;
let speakWavePhase = 0;
let analyser, dataArray;

async function startWaveAnimation() {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const audioContext = new AudioContext();
    const source = audioContext.createMediaStreamSource(stream);

    analyser = audioContext.createAnalyser();
    analyser.fftSize = 2048;

    dataArray = new Uint8Array(analyser.frequencyBinCount);
    source.connect(analyser);

    drawWave();
}

function drawWave() {
    requestAnimationFrame(drawWave);

    const canvas = document.getElementById("voiceWave");
    const ctx = canvas.getContext("2d");

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    ctx.lineWidth = 3;
    ctx.strokeStyle = "#00eaff";
    ctx.shadowBlur = 10;
    ctx.shadowColor = "#00eaff";
    ctx.beginPath();

    let sliceWidth = canvas.width / dataArray.length;
    let x = 0;

    if (analyser && !phoenixSpeaking) {
        analyser.getByteTimeDomainData(dataArray);
    } else if (phoenixSpeaking) {
        speakWavePhase += 0.15;
        for (let i = 0; i < dataArray.length; i++) {
            let v = Math.sin(i * 0.04 + speakWavePhase);
            dataArray[i] = 128 + v * 40;
        }
    }

    for (let i = 0; i < dataArray.length; i++) {
        let v = dataArray[i] / 128;
        let y = (v * canvas.height) / 2;

        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);

        x += sliceWidth;
    }

    ctx.stroke();
}

startWaveAnimation();


/* --- Blinking --- */
const lids = document.querySelectorAll(".eye-lid");

function robotBlink() {
  lids.forEach(lid => {
    lid.style.animation = "blink 300ms ease-in-out";
    setTimeout(() => lid.style.animation = "", 320);
  });
}

setInterval(() => {
  if (Math.random() > 0.3) robotBlink();
}, 2000);


/* --- Eyes Follow Cursor --- */
const pupils = document.querySelectorAll(".eye-core");

document.addEventListener("mousemove", e => {
  const x = (e.clientX / window.innerWidth - 0.5) * 20;
  const y = (e.clientY / window.innerHeight - 0.5) * 20;

  pupils.forEach(p => {
    p.style.transform = `translate(${x}px, ${y}px)`;
  });
});

  </script>
</body>

</html>